<div class='spin' style='margin:10vw 10vw 5vw 10vw'>
  <div class="row" >
    <div class="col-md-3 prof-box">
      <%= image_tag(@user.avatar.url,:style =>"width:15vw;margin:10px") %>
      <%if @user ==@current_user%>
        <h4><%=link_to edit_user_path_url(@user), :id=>"edit-user-pencil" do%><i class="glyphicon glyphicon-pencil"></i><%end%></h4>
      <%end%>
      <h3 style ='color:lightgray'><%= @user.company_name if @user.company_name%></h3>
      <h3 style ='color:lightgray'><%= @user.email%></h3>
      <h4 style ='color:lightgray'><%= @user.city%>, <%= @user.state%></h4>
    </div>

    <%if @user.is_vendor%>
    <div class="col-md-9 prof-info">
      <h3 style='float:right;margin-right:60px'>Closed Orders:</h3>
      <h3 style='float:right;margin-right:120px'>Open Orders:</h3>
      <h2 > Items:<h2>
        <%if @user == @current_user%>
          <h4 style='width:20%;margin:-10px'class="bulk_order_link"><%=link_to 'Add Item',new_item_path%></h4>
        <%end%>
        <ul>
          <%@user.items.each_with_index do |item,i|%>
            <hr>
            <div class="row">
              <div class='col-md-1'>
                <h3 style='margin-left:-50px'><%=image_tag(item.avatar.url, :size => "120x120")%></h3>
                <%if @user ==@current_user%>
                <h4><%=link_to edit_item_path(item), :id=>"edit-user-pencil" do%><i class="glyphicon glyphicon-pencil"></i><%end%></h4>
                <%end%>
              </div>
              <div class='col-md-3'>
                <h3><%=item.item_name%> -</h3>
                <h4>$<%=item.price%>/g</h4>
                <h4><%=item.current_amount%> / <%=item.max_amount%> grams left</h4>
                <h4><button class='show-btn'id='<%=i%>'>Show Orders</button></h4>
                <%if item.current_amount == 0%>
                  <span class="bulk_order_link"><%=link_to 'Re Up Item', edit_item_path(item)%></span>
                <%end%>
              </div>
              <div class='col-md-7'>
                <br>
                <div class="row" class='orders' hidden id='<%=i%>_orders'>
                  <ul>
                    <%if item.bulk_orders.count > 0%>
                    <div class="col-md-7">
                      <%item.bulk_orders.where(completed: false).each do |bulk|%>
                        <%bulk.user_orders.each do |order|%>
                          <%if order.user == @current_user%>
                            <%@contains_current_user = order.id%>
                            <%break%>
                          <%else%>
                            <%@contains_current_user = false%>
                          <%end%>
                        <%end%>
                        <%if @contains_current_user%>
                          <%=link_to edit_user_order_path(@contains_current_user,item:bulk.item.id) do %>
                            <h5><li><%=bulk.percent_filled%>/<%=bulk.max_amount%> spots filled
                              <br>
                              <%=bulk.users.count%> Users in order<br>
                              $<%=bulk.item.price * bulk.percent_filled%> - to be paid
                            </li></h5>
                          <%end%>
                        <%else%>
                          <%=link_to bulk_order_path(bulk) do %>
                            <h5><li><%=bulk.percent_filled%>/<%=bulk.max_amount%> spots filled<br>
                            <%=bulk.users.count%> Users in order<br>
                            $<%=bulk.item.price * bulk.percent_filled%> - to be paid</li></h5>
                          <%end%>
                        <%end%>
                        <hr>
                    <%end%>
                  </div>
                  <div class="col-md-5">
                    <%item.bulk_orders.where(completed: true).each do |bulk|%>
                      <%=link_to bulk_order_path(bulk) do %>
                      <h5><li><%=bulk.percent_filled%>/<%=bulk.max_amount%> spots filled<br>
                      <%=bulk.users.count%> Users in order<br>
                      $<%=bulk.item.price * bulk.percent_filled%> - paid
                      <%end%></li></h5>
                      <hr>
                    <%end%>
                  </div>
                  <br>
                <%else%>
                NO ORDERS YET
                <%end%>
                  </ul>
                </div>
              </div>
            </div>
          <%end%>
        </ul>
        <hr>
    </div>
  </div>
  <%if @current_user == @user%>
    <div class='row'>
      <div class='col-md-3'>
        <br>
        <h4>Keep an Eye out for open bids!</h4>
      </div>
      <div class='col-md-9'>
        <div class='col-md-6'>
          <h2 class='text-center'> Open Bids:</h2>
          <%@user_bids_open.each do |bid|%>
            <h4>Title: <%=bid.title%><h4>
            <h4>Amount: <%=bid.amount%> grams<h4>
            <h4>Price range: $<%=bid.price_min%> - $<%=bid.price_max%><h4>
              <%if @user.bid_offers.where(bid: bid).exists?%>
                <%=link_to 'View Your Offer',bid_offer_path(@user.bid_offers.where(bid: bid)[0])%>
              <%else%>
                <%=link_to 'Make an Offer',new_bid_offer_path(:bid_id => bid.id)%>
              <%end%>
              <hr>
          <%end%>
        </div>
        <div class='col-md-6'>
          <h2 class='text-center'> Closed Bids:</h2>
          <%@user_bids_supplier.each do |bid|%>
            <h4>Title: <%=bid.title%><h4>
            <h4>Amount: <%=bid.amount%> grams<h4>
            <h4>Final Price: $<%=bid.bid_offers[0].price%><h4>
            <h4>Buyer: <%=bid.buyer.email%><h4>
              <hr>
          <%end%>
        </div>
      </div>
    </div>
  <%end%>
  <%else%>
    <div class="col-md-9 prof-info">
      <div class="row">
        <div class='col-md-6'>
          <h2 class='text-center'> Open Orders:</h2>
          <%@user.user_orders.each do |order|%>
            <%if order.bulk_order && order.bulk_order.completed == false%>
              <div class="row">
                <div class='col-md-4'>
                  <%=image_tag(order.order_item.avatar.url, :size => "120x120")%>
                </div>
                <div class='col-md-8'>
                  <h3><%=order.order_item.name%>-<br>
                  <%=order.quantity rescue nil%> grams for $<%=order.total_price rescue nil%><br>
                  <%=link_to edit_user_order_path(order,:order_item => order.order_item.id, :price => (order.total_price/order.quantity)) do%><i class="glyphicon glyphicon-pencil"></i><%end%>
                  <%=link_to user_order_path(order), :method => :delete do %><i class="glyphicon glyphicon-trash"></i><%end%></h3>
                  <%@bulk_order = order.bulk_order%>
                  <h4><%=@bulk_order.percent_filled%>/<%=@bulk_order.max_amount%> Spots of this Order Filled</h4>
                  <hr>
                </div>
              </div>
            <%end%>
          <%end%>
        </div>
          <div class='col-md-6'>
          <h2 class='text-center'> Finished Orders:</h2>
          <%@user.user_orders.each do |order|%>
          <%if (order.bulk_order && order.bulk_order.completed == true) || order.buy_now ==true%>
            <div class="row">
              <div class='col-md-4'>
                <%=image_tag(order.order_item.avatar.url, :size => "120x120")%>
              </div>
              <div class='col-md-8'>
            <h3><%=order.order_item.name%>-<br>
              <%=order.quantity rescue nil%> grams for $<%=order.total_price rescue nil%><br></h3>
              <%if order.bulk_order ==nil%>
                <h5>*Buy Now Order</h5>
                <h3><%=link_to user_order_path(order) do%><i class="glyphicon glyphicon-eye-open"></i><%end%></h3>
              <%else%>
                <h5>*Part of Bulk Order</h5>
                <h3><%=link_to bulk_order_path(order.bulk_order) do%><i class="glyphicon glyphicon-eye-open"></i><%end%></h3>
                <!-- <%@bulk_order = order.bulk_order%> -->
                <!-- <h4><%=@bulk_order.percent_filled%>/<%=@bulk_order.max_amount%> Spots of this Order Filled</h4> -->
              <%end%>
                <hr>
              </div>
            </div>
            <%end%>
          <%end%>
        </div>
      </div>
    </div>
  </div>
  <div class='row'>
    <div class='col-md-3'>
      <br>
      <h4>Cant find the right order for you? Create your own here!</h4>
      <h4><%=link_to new_bid_path do%><i class="glyphicon glyphicon-pencil"></i> Create Bid<%end%></h4>
    </div>
    <div class='col-md-9'>
      <div class='col-md-6'>
        <h2 class='text-center'> Open Bids:</h2>
        <%@user_bids_buyer_open.each do |bid|%>
          <h4>Title: <%=bid.title%><h4>
          <h4>Amount: <%=bid.amount%> grams<h4>
          <h4>Price range: $<%=bid.price_min%> - $<%=bid.price_max%><h4>
          <%if bid.bid_offers.present?%>
            <%=link_to 'View All Bids',bid_offers_path(:bid_id => bid.id)%>
          <%else%>
            <h4>**No Bids Yet</h4>
          <%end%>
          <hr>
        <%end%>
      </div>
      <div class='col-md-6'>
        <h2 class='text-center'> Closed Bids:</h2>
        <%@user_bids_buyer_closed.each do |bid|%>
          <h4>Title: <%=bid.title%><h4>
          <h4>Amount: <%=bid.amount%> grams<h4>
          <h4>Final Price: $<span class='bid_price'><%=bid.bid_offers[0].price %></span><h4>
          <h4>Supplier: <%=bid.supplier.email%><h4>
          <h4>Delivery Date:<%=bid.bid_offers[0].delivery_date%></h4>
          <%if bid.paid%>
            <h4>Order is being Proccesed</h4>
          <%else%>
            <button type="submit" id = 'payButton' class='payBidButton' onclick="payStripe('<%=bid.bid_offers[0].price%>')">PAY</button>
          <%end%>
            <hr>
        <%end%>
      </div>
    </div>
  </div>
  <%end%>
</div>
  <div hidden id='user_email'><%=@user.email%></div>
  <article>
    <%= hidden_field_tag(:amount) %>
  </article>
  <article>
    <%= hidden_field_tag(:stripeToken) %>
  </article>
</form>
  <script src="https://checkout.stripe.com/checkout.js"></script>
  <script>

  function payStripe(amount){
    var user_email = $('#user_email').text()
    handler.open({
      amount: amount * 100,
      description:'Bid Payment',
      email:user_email
    });
  }
  var handler = StripeCheckout.configure({
    key: '<%= Rails.configuration.stripe[:publishable_key] %>',
    image: 'https://stripe.com/img/documentation/checkout/marketplace.png',
    locale: 'auto',
    name: $('#item_name').text(),
    token: function(token) {
      $('input#stripeToken').val(token.id);
      $('input#amount').val(amount)

      $(".spin").spin({
        lines: 12, // The number of lines to draw
        length: 15, // The length of each line
        width: 9, // The line thickness
        radius: 30, // The radius of the inner circle
        color: '#000', // #rgb or #rrggbb
        speed: 1, // Rounds per second
        trail: 60, // Afterglow percentage
        shadow: false // Whether to render a shadow
      });
      // MAKE AJAX CALL TO SAY BID HAS BEEN PAID
      $('form').submit()
    }
  });
$(window).on('popstate', function() {
  handler.close();
});

  $('.show-btn').on('click',function(){
    var text = $(this).html()
    $('#'+this.id+'_orders').toggle('fast');
    $(this).html(text == 'Show Orders' ? 'Hide Orders' : 'Show Orders')
  })
</script>
