
<form action="/bulk_orders<%= "/#{@bulk_order.id}" unless @bulk_order.new_record? %>" method="POST" >
    <%= "<input type=\"hidden\" name=\"_method\" value=\"PATCH\">".html_safe unless @bulk_order.new_record? %>
    <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
    <% if bulk_order.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(bulk_order.errors.count, "error") %> prohibited this bulk_order from being saved:</h2>
      <ul>
      <% bulk_order.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class ="row edit-row spin">
      <div class="col-md-6 edit-card">
        <%=link_to item_path(@bulk_order.item) do %>
          <span style='float:right' class='oil-image'><%= image_tag(@bulk_order.item.avatar.url, :size => "220x220") %></span>
        <%end%>
        <h1 id='item_name'><%= @bulk_order.item_name %></h1>
        <h3><%= @bulk_order.wholesale_price %>$ / gram</h3>
        <h4><%=@bulk_order.max_amount - @bulk_order.percent_filled%> grams available</h4>
        <h4><i><%=@bulk_order.description rescue nil%></i></h4>
        <h4><%=link_to user_supplier_path_url(@seller) do%>
          <%= image_tag(@seller.avatar.url, :size => "50x50") %>
          <%=@seller.company_name%></h3>
          <%end%>
        </h4>
      </div>
      <div class='col-md-3' style='font-size:1.2em;margin-top:-5vh'>
        <div class='row edit-card' style='margin-top:5vh'>
          <div id='small-clock'></div>
        </div>
        <%if @user && @user.is_vendor == false%>
          <div class='row' style='padding-left:10px;margin-top:2vw'>
            <div class="field" >
              <label>Quantity (grams)</label>
              <div id="slider-range-min"></div>
            </div>
            <input type="text" id="user_order_quantity" value='0' readonly style="border:0; color:#f6931f; font-weight:bold;"></input>
            <div class="field">
              <label>Price</label>
              <span id='total_price'>$</span>
            </div>
            <button type="submit" id='payButton'>PAY</button>
            <h5>Your card will only be charged when this bulk order fills</h5>
          </div>
        <%elsif @seller==@user%>
        <h4>Buyers:</h4>
          <% @bulk_order.user_orders.each do |user_order| %>
            <%if !user_order.buy_now %>
              <% @user_found = User.find_by_id(user_order.user_id)%>
              <strong><%=@user_found.email%></strong>
              <ul>
                <li> Bought <%=user_order.quantity%> <%=@bulk_order.item_name%> for $<%=user_order.total_price%> on <%=Date.parse(user_order.updated_at.to_date.to_s).strftime('%m/%d/%Y')|| ate.parse(user_order.created_at.to_date.to_s).strftime('%m/%d/%Y')%></li>
                <li>Lives in <%=@user_found.city%>, <%=@user_found.state%></li>
              </ul>
              <hr>
            <%end%>
          <%end%>
        <%else%>
        <div class='row' style='padding-left:10px;margin-top:2vw'>
          <div class="field" >
            <label>Quantity (grams)</label>
            <div id="slider-range-min"></div>
          </div>
          <input type="text" id="user_order_quantity" value='0' readonly style="border:0; color:#f6931f; font-weight:bold;"></input>
          <div class="field">
            <label>Price</label>
            <span id='total_price'>$</span>
          </div>
          <button type="submit" id='payButton'>PAY</button>
          <h5>Your card will only be charged when this bulk order fills</h5>
        </div>
        <%end%>
      </div>
      <div class='col-md-3 '>
        <div class='row'>
          <div id='pieChart'></div>
        </div>
      </div>
    </div>

    <div class='row' style='margin:-3vw 3vw 0vw 3vw'>
      <h2 class='text-left'>Customer Reviews</h2>
      <%@reviews.each do |review|%>
      <%=link_to user_path_url(review.user) do%>
        <h5><%= image_tag(review.user.avatar.url, :class => "not_nav_prof_pic",) %>
      <%end%>
      <%=review.user.email%></h5>
      <h4><%review.rating.times do%>
      <i class="glyphicon glyphicon-star"></i>
      <%end%>
      <%(5-review.rating).times do%>
      <i class="glyphicon glyphicon-star-empty"></i>
      <%end%>
      <%=review.title%></h4>
      <h5><%=review.body%></h5>
      <hr>
      <%end%>
    </div>

  <%= hidden_field_tag(:user_id, @user.id) rescue nil%>
  <%= hidden_field_tag(:item,params[:item])%>
  <%= hidden_field_tag(:price,params[:price])%>
  <div hidden>
  <span id='item_price'><%= @bulk_order.wholesale_price %></span>
  <span id='max_amount'><%= @bulk_order.max_amount%></span>
  <span id='percent_filled'><%=@bulk_order.percent_filled rescue 0%></span>
  <span id='expire_date'><%=@bulk_order.expire_date rescue nil%></span>
  <span id='item'><%=@bulk_order.item rescue nil%></span>
  <span id='user_email'><%=@user.email rescue nil%></span>
  <%@bulk_order.user_orders.each do |order|%>
    <%if @user && order.user_id == @user.id && order.buy_now != true%>
    <span id='user_order_quantity'><%=order.quantity%></span>
    <%end%>
  <%end%>
  </div>

  <article>
    <%= hidden_field_tag(:amount) %>
  </article>
  <article>
    <%= hidden_field_tag(:quantity) %>
  </article>
  <article>
    <%= hidden_field_tag(:stripeToken) %>
  </article>
  <article>
    <%= hidden_field_tag(:stripeEmail) %>
  </article>
  <article>
    <%= hidden_field_tag(:shipping) %>
  </article>
  <article>
    <%= hidden_field_tag(:billing) %>
  </article>
</form>

  <script src="https://checkout.stripe.com/checkout.js"></script>
  <script>
  var payment_amount=0;

  $('#payButton').on('click', function(e) {
    e.preventDefault();
      handler.open({
        billingAddress:true,
        shippingAddress:true,
        amount: Math.round(payment_amount),
        description: user_order_quant + ( user_order_quant > 1 ? ' grams':' gram'),
        email:$('#user_email').text(),
      });
  });
  var handler = StripeCheckout.configure({
    key: '<%= Rails.configuration.stripe[:publishable_key] %>',
    image: 'https://stripe.com/img/documentation/checkout/marketplace.png',
    locale: 'auto',
    name: $('#item_name').text(),
    token: function(token,args) {
      $('input#stripeToken').val(token.id);
      $('input#stripeEmail').val(token.email);
      $('input#amount').val(payment_amount)
      $('input#quantity').val(user_order_quant)
      $('input#shipping').val([args['shipping_address_line1'],args['shipping_address_city'],args['shipping_address_state'],args['shipping_address_zip'],args['shipping_name'],args['shipping_address_apt']])
      $('input#billing').val([args['billing_address_line1'],args['billing_address_city'],args['billing_address_state'],args['billing_address_zip'],args['billing_name'],args['billing_address_apt']])
      $(".spin").spin({
        lines: 12, // The number of lines to draw
        length: 15, // The length of each line
        width: 9, // The line thickness
        radius: 30, // The radius of the inner circle
        color: '#000', // #rgb or #rrggbb
        speed: 1, // Rounds per second
        trail: 60, // Afterglow percentage
        shadow: false // Whether to render a shadow
      });

      $('form').submit()
    }
  });
$(window).on('popstate', function() {
  handler.close();
});

var percent_filled = $('#percent_filled').text();
var user_order_quant = $('#user_order_quantity').text();
var other_order_quant = (percent_filled -user_order_quant)
var max_amount = $('#max_amount').text();
var expire_date = $('#expire_date').text();
  var item_price = parseInt($('#item_price').text());
  var item = $('#item').val();
  function renderPieChart(){
    var Apiec3 = c3.generate({
      bindto: '#pieChart',
      data: {
        columns: [
          ['Your Order', user_order_quant],
          ['Other', other_order_quant || 0],
          ['Remaining',  max_amount-(percent_filled)],
        ],
        type : 'donut',
      },
      legend: {
        position: 'right'
      },
      donut: {
        title: ( (percent_filled ||0)+"/"+max_amount+" spots taken"),
        label: {
          show:true
        }
      },
      legend: {
        show: false
      }
    });
  }
  function renderSlider(){
    $( "#slider-range-min" ).slider({
      range: "min",
      value: user_order_quant,
      min: 1,
      max: max_amount - percent_filled,
      slide: function( event, ui ) {
        user_order_quant = ui.value;
        percent_filled = parseInt(other_order_quant) +parseInt(user_order_quant);
        remaining_quant = (parseInt(max_amount)-parseInt(percent_filled));
        $('#user_order_quantity').val(ui.value);
        renderPieChart();
        $('#total_price').text( '$'+ (item_price * user_order_quant));
        $( "#amount" ).val(ui.value );
        payment_amount =(parseInt(item_price * user_order_quant)) * 100
      }
    });
    $( "#amount" ).val( "$" + $( "#slider-range-min" ).slider( "value" ) );
  }

  renderSlider();

  setTimeout(function(){
    renderPieChart();
  },10)
  // d3.select(".c3-chart-arcs-title")
  //     .append("tspan")
  //     .attr("dy", 16)
  //     .attr("x", 0)
  //     .text( (percent_filled ||0)+"/"+max_amount+" spots taken");

  var clock_1 = new FlipClock($('#small-clock'),new Date(expire_date || 0), {
  countdown: true,
  clockFace: 'DailyCounter'
  });
  </script>
