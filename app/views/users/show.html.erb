<%if @user == @current_user%>
  <div class="tabs-right tab-sideways tabs-krajee">
    <ul id="myTab" style='position:absolute;margin-top:10vw'class="nav nav-tabs" role="tablist">
      <li class="active"><a href="#id01" role="tab" data-toggle="tab" >Market Place</a></li>
      <li><a href="#id02" role="tab" data-toggle="tab">Brokerage</a></li>
      <li><a href="#id03" role="tab" data-toggle="tab">Distribution</a></li>
    </ul>
  </div>
<%end%>

<div class='spin' style='margin:10vw 10vw 5vw 10vw'>
  <div class="row" >
    <div class="col-md-3 prof-box">
      <%= image_tag(@user.avatar.url,:style =>"width:15vw;margin:10px") %>
      <%if @user ==@current_user%>
        <h4><%=link_to edit_user_path_url(@user), :id=>"edit-user-pencil" do%><i class="glyphicon glyphicon-pencil"></i><%end%></h4>
      <%end%>
      <h3 style ='color:lightgray'><%= @user.company_name if @user.company_name%></h3>
      <h3 style ='color:lightgray'><%= @user.email%></h3>
      <h4 style ='color:lightgray'><%= @user.city%>, <%= @user.state%></h4>
    </div>
    <div id="myTabContent" class="tab-content">
      <div class="tab-pane fade in active" id="id01">
        <div class='col-md-1'>
        </div>
        <div class="col-md-8 prof-info">
          <h2 style='margin-left:-4vw'> Orders</h2>
          <div class='row'>
            <h2 class="text-center"> Open Orders:</h2>
            <%@open_orders.each do |order|%>
            <div class='col-md-6'>
              <div class='row'>
                <div class='col-md-6'>
                  <h4><%=order.bulk_order.item_name%></h4>
                  <h3 ><%=image_tag(order.bulk_order.item.avatar.url, :size => "120x120")%></h3>
                </div>
                <div class='col-md-6'>
                  <h4><%=order.bulk_order.percent_filled%> / <%=order.bulk_order.max_amount%> g reserved</h4>
                  <h4><%=order.quantity%>grams</h4>
                  <h4>Spent: $<%=order.total_price%></h4>
                  <h3><%=link_to edit_user_order_path(order) do%><i class="glyphicon glyphicon-pencil"></i><%end%>
                  <%=link_to user_order_path(order), :method => :delete do %><i class="glyphicon glyphicon-trash"></i><%end%></h3>
                </div>
              </div>
              <hr>
            </div>
            <%end%>
          </div>
          <div class='row'>
            <h2 class="text-center"> Closed Orders:</h2>
            <%@closed_orders.each do |order|%>
            <div class='col-md-6'>
              <div class='row'>
                <div class='col-md-6'>
                  <h4><%=order.bulk_order.item_name%></h4>
                  <h3 ><%=image_tag(order.bulk_order.item.avatar.url, :size => "120x120")%></h3>
                  <%if order.buy_now%>

                  <%end%>
                </div>
                <div class='col-md-6'>
                  <h4><%=order.quantity%>grams</h4>
                  <h4>Spent: $<%=order.total_price%></h4>
                  <%if order.buy_now%>
                  <h5>** Buy Now Order</h5>
                    <h3><%=link_to user_order_buy_now_path_url(order) do%><i class="glyphicon glyphicon-eye-open"></i><%end%></h3>
                  <%else%>
                  <h4><%=order.bulk_order.percent_filled%> / <%=order.bulk_order.max_amount%> g</h4>
                    <h3><%=link_to user_order_path(order) do%><i class="glyphicon glyphicon-eye-open"></i><%end%></h3>
                  <%end%>
                </div>
              </div>
              <hr>
            </div>
            <%end%>
          </div>
        </div>
      </div>
    <div class="tab-pane fade" id="id02">
      <div class="col-md-9 prof-info">
      <div class='row'>
        <div class='col-md-3'>
          <br>
          <h4>Cant find the right order for you? Create your own here!</h4>
          <h4><%=link_to new_bid_path do%><i class="glyphicon glyphicon-pencil"></i> Create Bid<%end%></h4>
        </div>
        <div class='col-md-9'>
          <div class='col-md-6'>
            <h2 class='text-center'> Open Bids:</h2>
            <%@user_bids_buyer_open.each do |bid|%>
              <h4>Title: <%=bid.title%><h4>
              <h4>Amount: <%=bid.amount%> grams<h4>
              <h4>Price range: $<%=bid.price_min%> - $<%=bid.price_max%><h4>
              <%if bid.bid_offers.present?%>
                <%=link_to 'View All Bids',bid_offers_path(:bid_id => bid.id)%>
              <%else%>
                <h4>**No Bids Yet</h4>
              <%end%>
              <hr>
            <%end%>
          </div>
          <div class='col-md-6'>
            <h2 class='text-center'> Closed Bids:</h2>
            <%@user_bids_buyer_closed.each do |bid|%>
              <h4>Title: <%=bid.title%><h4>
              <h4>Amount: <%=bid.amount%> grams<h4>
              <h4>Final Price: $<span class='bid_price'><%=bid.bid_offers[0].price %></span><h4>
              <h4>Supplier: <%=bid.supplier.email%><h4>
              <h4>Delivery Date:<%=bid.bid_offers[0].delivery_date%></h4>
              <%if bid.paid%>
                <h4>Order is being Proccesed</h4>
              <%else%>
                <button type="submit" id = 'payButton' class='payBidButton' onclick="payStripe('<%=bid.bid_offers[0].price%>')">PAY</button>
              <%end%>
                <hr>
            <%end%>
          </div>
        </div>
      </div>
    </div>
    </div>
    <div class="tab-pane fade" id="id03">
      <div class="col-md-9 prof-info">
        <h3>RETAIL DISTRIBUTION IS UNDER CONSTRUCTION</h3>
        <h4>Please Contact Us</h4>
      </div>
    </div>
    </div>
  </div>
</div>
  <div hidden id='user_email'><%=@user.email%></div>
  <article>
    <%= hidden_field_tag(:amount) %>
  </article>
  <article>
    <%= hidden_field_tag(:stripeToken) %>
  </article>
</form>
  <script src="https://checkout.stripe.com/checkout.js"></script>
  <script>

  function payStripe(amount){
    var user_email = $('#user_email').text()
    handler.open({
      amount: amount * 100,
      description:'Bid Payment',
      email:user_email
    });
  }
  var handler = StripeCheckout.configure({
    key: '<%= Rails.configuration.stripe[:publishable_key] %>',
    image: 'https://stripe.com/img/documentation/checkout/marketplace.png',
    locale: 'auto',
    name: $('#item_name').text(),
    token: function(token) {
      $('input#stripeToken').val(token.id);
      $('input#amount').val(amount)

      $(".spin").spin({
        lines: 12, // The number of lines to draw
        length: 15, // The length of each line
        width: 9, // The line thickness
        radius: 30, // The radius of the inner circle
        color: '#000', // #rgb or #rrggbb
        speed: 1, // Rounds per second
        trail: 60, // Afterglow percentage
        shadow: false // Whether to render a shadow
      });
      // MAKE AJAX CALL TO SAY BID HAS BEEN PAID
      $('form').submit()
    }
  });
$(window).on('popstate', function() {
  handler.close();
});

  $('.show-btn').on('click',function(){
    var text = $(this).html()
    $('#'+this.id+'_orders').toggle('fast');
    $(this).html(text == 'Show Orders' ? 'Hide Orders' : 'Show Orders')
  })
</script>
