
<form action="/bulk_orders<%= "/#{@bulk_order.id}" unless @bulk_order.new_record? %>" method="POST" >
    <%= "<input type=\"hidden\" name=\"_method\" value=\"PATCH\">".html_safe unless @bulk_order.new_record? %>
    <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
    <% if bulk_order.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(bulk_order.errors.count, "error") %> prohibited this bulk_order from being saved:</h2>
      <ul>
      <% bulk_order.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class ="row edit-row spin">
      <div class="col-md-6 edit-card">
        <%=link_to item_path(@bulk_order.item) do %>
          <span style='float:right' class='oil-image'><%= image_tag(@bulk_order.item.avatar.url, :size => "250x250") %></span>
        <%end%>
        <h1 id='item_name'><%= @bulk_order.item_name %></h1>
        <h4><%=link_to user_supplier_path_url(@seller) do%>
          <%=@seller.company_name%></h3>
          <%end%>
        </h4>
        <h4><%= @bulk_order.wholesale_price %>$ / gram</h4>
        <h4> Order Size - <%= @bulk_order.max_amount %> grams</h4>
        <h4><%=@bulk_order.max_amount - @bulk_order.percent_filled%> grams available</h4>
        <h4><%=@bulk_order.description rescue nil%></h4>
      </div>
      <div class='col-md-3' style='font-size:1.2em;margin-top:-5vh'>
        <div class='row edit-card' style='margin-top:5vh'>
          <div id='small-clock'></div>
        </div>
        <%if @user.is_vendor == false%>
          <div class="field" >
            <label>Quantity (g)</label>
            <input style='width:7vw' type='number' id='order_quant' min='1' max="'<%=@bulk_order.max_amount - (@bulk_order.percent_filled ||0)%>'" name='bulk_order[quantity]'>
          </div>
          <div class="field">
            <label>Price</label>
            <span id='total_price'>$</span>
          </div>
          <button type="submit" id='payButton'>PAY</button>
        <%elsif @seller==@user%>
        <h4>Buyers:</h4>
          <% @bulk_order.user_orders.each do |user_order| %>
            <% @user_found = User.find_by_id(user_order.user_id)%>
            <strong><%=@user_found.email%></strong>
            <ul>
              <li> Bought <%=user_order.quantity%> <%=@bulk_order.item_name%> for $<%=user_order.total_price%> on <%=Date.parse(user_order.updated_at.to_date.to_s).strftime('%m/%d/%Y')|| ate.parse(user_order.created_at.to_date.to_s).strftime('%m/%d/%Y')%></li>
              <li>Lives in <%=@user_found.city%>, <%=@user_found.state%></li>
            </ul>
          <br>
          <%end%>
        <%end%>
      </div>
      <div class='col-md-3 '>
        <div class='row'>
          <div id='pieChart'></div>
        </div>
      </div>
    </div>

    <div class='row' style='margin:-3vw 3vw 0vw 3vw'>
      <h2 class='text-left'>Customer Reviews</h2>
      <%@reviews.each do |review|%>
      <%=link_to user_path_url(review.user) do%>
        <h5><%= image_tag(review.user.avatar.url, :class => "not_nav_prof_pic",) %>
      <%end%>
      <%=review.user.email%></h5>
      <h4><%review.rating.times do%>
      <i class="glyphicon glyphicon-star"></i>
      <%end%>
      <%(5-review.rating).times do%>
      <i class="glyphicon glyphicon-star-empty"></i>
      <%end%>
      <%=review.title%></h4>
      <h5><%=review.body%></h5>
      <hr>
      <%end%>
    </div>

  <%= hidden_field_tag(:user_id, @user.id)%>
  <%= hidden_field_tag(:item,params[:item])%>
  <%= hidden_field_tag(:price,params[:price])%>
  <div hidden>
  <span id='item_price'><%= @bulk_order.wholesale_price %></span>
  <span id='max_amount'><%= @bulk_order.max_amount%></span>
  <span id='percent_filled'><%=@bulk_order.percent_filled rescue 0%></span>
  <span id='expire_date'><%=@bulk_order.expire_date rescue nil%></span>
  <span id='item'><%=@bulk_order.item rescue nil%></span>
  <%@bulk_order.user_orders.each do |order|%>
    <%if order.user_id == @user.id && order.buy_now != true%>
    <span id='user_order_quantity'><%=order.quantity%></span>
    <%end%>
  <%end%>
  </div>

  <article>
    <%= hidden_field_tag(:amount) %>
  </article>

  <article>
    <%= hidden_field_tag(:stripeToken) %>
  </article>
</form>

  <script src="https://checkout.stripe.com/checkout.js"></script>
  <script>
  var amount=0;
  $('#order_quant').on('input',function(){
    var order_quant = parseInt($('#order_quant').val());
    amount = parseInt(item_price * order_quant)
    amount = amount * 100; // Needs to be an integer!
  });
  $('#payButton').on('click', function(e) {
    e.preventDefault();
    if(parseInt($('#order_quant').val()) > (parseInt($('#max_amount').text()) - parseInt($('#percent_filled').text()) ) ){
      $('#order_quant').css("border","3px solid red");
    }else{
      handler.open({
        amount: Math.round(amount),
        description: $('#order_quant').val() + ( $('#order_quant').val() > 1 ? ' grams':' gram'),
        email:'<%=@user.email%>'
      });
    }
  });
  var handler = StripeCheckout.configure({
    key: '<%= Rails.configuration.stripe[:publishable_key] %>',
    image: 'https://stripe.com/img/documentation/checkout/marketplace.png',
    locale: 'auto',
    name: $('#item_name').text(),
    token: function(token) {
      $('input#stripeToken').val(token.id);
      $('input#amount').val(amount)

      $(".spin").spin({
        lines: 12, // The number of lines to draw
        length: 15, // The length of each line
        width: 9, // The line thickness
        radius: 30, // The radius of the inner circle
        color: '#000', // #rgb or #rrggbb
        speed: 1, // Rounds per second
        trail: 60, // Afterglow percentage
        shadow: false // Whether to render a shadow
      });

      $('form').submit()
    }
  });
$(window).on('popstate', function() {
  handler.close();
});
</script>

<script>
var percent_filled = $('#percent_filled').text();
var user_order_quant = $('#user_order_quantity').text();
var other_order_quant = (percent_filled -user_order_quant)
var max_amount = $('#max_amount').text();
var expire_date = $('#expire_date').text();
  var item_price = parseInt($('#item_price').text());
  var max_amount = $('#max_amount').text();
  var item = $('#item').val();
  $('#order_quant').on('input',function(){
    var order_quant = parseInt($('#order_quant').val());
    $('#total_price').text( '$'+ (item_price * order_quant));
  });

  var Apiec3 = c3.generate({
    bindto: '#pieChart',
      data: {
          columns: [
              ['Your Order', user_order_quant],
              ['Other', other_order_quant || 0],
              ['Remaining',  max_amount-(percent_filled)],
          ],
          type : 'donut',
      },
      legend: {
      position: 'right'
      },
      donut: {
          title: ( (percent_filled ||0)+"/"+max_amount+" spots taken"),
          label: {
            show:true
          }
      },
      legend: {
        show: false
      }
  });

  // d3.select(".c3-chart-arcs-title")
  //     .append("tspan")
  //     .attr("dy", 16)
  //     .attr("x", 0)
  //     .text( (percent_filled ||0)+"/"+max_amount+" spots taken");

  var clock_1 = new FlipClock($('#small-clock'),new Date(expire_date || 0), {
  countdown: true,
  clockFace: 'DailyCounter'
  });
  </script>
